<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Firebase Web Messenger</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Подключение Firebase SDK (Совместимые версии для простоты) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <!-- Подключение библиотеки Socket.io клиента -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        /* Убираем скроллбар для красоты */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        /* Фиксированный размер для мобильного вида */
        #app {
            max-width: 480px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">

<div id="app" class="h-full flex flex-col bg-white shadow-xl relative">

    <!-- ЭКРАН 1: АУТЕНТИФИКАЦИЯ (Вход/Регистрация/Сброс) -->
    <div v-if="!registered" class="flex flex-col justify-center items-center h-full p-6">
        <h1 class="text-3xl font-bold mb-8 text-blue-600">
            <span v-if="authMode === 'login'">Вход</span>
            <span v-else-if="authMode === 'register'">Регистрация</span>
            <span v-else>Сброс пароля</span>
        </h1>

        <input v-model="emailInput" type="email" placeholder="Email" class="w-full p-4 border border-gray-300 rounded-xl mb-4 text-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
        
        <input v-if="authMode !== 'reset'" v-model="passwordInput" type="password" placeholder="Пароль" class="w-full p-4 border border-gray-300 rounded-xl mb-6 text-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">

        <!-- Кнопки входа/регистрации/сброса -->
        <button v-if="authMode === 'login'" @click="loginUser" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold active:bg-blue-700 transition shadow-lg">
            Войти
        </button>
        <button v-else-if="authMode === 'register'" @click="registerUser" class="w-full bg-green-500 text-white p-4 rounded-xl font-bold active:bg-green-600 transition shadow-lg">
            Зарегистрироваться
        </button>
        <button v-else @click="resetPassword" class="w-full bg-yellow-500 text-white p-4 rounded-xl font-bold active:bg-yellow-600 transition shadow-lg">
            Сбросить
        </button>

        <!-- Переключатели режима -->
        <div class="mt-8 text-center text-sm space-y-3">
            <p v-if="authMode === 'login'">
                Нет аккаунта? 
                <button @click="authMode = 'register'" class="text-blue-600 font-semibold hover:underline">Регистрация</button>
            </p>
            <p v-if="authMode !== 'reset'">
                <button @click="authMode = 'reset'" class="text-gray-500 hover:underline">Забыли пароль?</button>
            </p>
            <p v-if="authMode !== 'login'">
                <button @click="authMode = 'login'" class="text-blue-600 font-semibold hover:underline">Вернуться ко входу</button>
            </p>
        </div>
    </div>

    <!-- ЭКРАН 2: СПИСОК ЧАТОВ -->
    <div v-else-if="!activeChat" class="flex flex-col h-full">
        <!-- Шапка -->
        <div class="bg-white p-4 border-b flex justify-between items-center sticky top-0 z-10 shadow-md">
            <span class="font-bold text-lg text-gray-800">{{ myUsername }} (Вы)</span>
            <div class="flex items-center space-x-3">
                <button @click="showCreateModal = true" class="text-blue-600 font-semibold text-2xl">+</button>
                <button @click="logoutUser" class="text-red-500 text-sm hover:underline">Выход</button>
            </div>
        </div>

        <!-- Список активных чатов -->
        <div class="flex-1 overflow-y-auto p-2">
            <div v-if="myChats.length === 0" class="text-center text-gray-400 mt-10">
                Нет чатов. Нажми +, чтобы начать.
            </div>
            <div v-for="chat in myChats" :key="chat.id" @click="openChat(chat)" class="bg-white p-4 mb-2 rounded-lg shadow-sm border flex items-center cursor-pointer hover:bg-gray-50 transition">
                <div :class="['w-10 h-10 rounded-full flex items-center justify-center font-bold mr-3 text-white', chat.type === 'group' ? 'bg-purple-500' : 'bg-blue-500']">
                    {{ chat.type === 'group' ? 'G' : chat.name ? chat.name[1].toUpperCase() : '?' }}
                </div>
                <div>
                    <div class="font-bold text-gray-800">{{ chat.name }}</div>
                    <div class="text-sm text-gray-500 truncate w-48">
                        {{ chat.messages.length ? chat.messages[chat.messages.length-1].text : 'Начните беседу' }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Модалка создания чата -->
        <div v-if="showCreateModal" class="absolute inset-0 bg-white z-20 flex flex-col">
            <div class="p-4 border-b flex items-center shadow-sm">
                <button @click="showCreateModal = false; selectedUsers = []" class="text-gray-500 mr-4">Отмена</button>
                <h2 class="font-bold text-lg">Новый чат (Онлайн: {{ otherUsers.length }})</h2>
            </div>
            <div class="p-2 flex-1 overflow-y-auto">
                <div v-if="otherUsers.length > 0" class="text-sm text-gray-400 mb-2 px-2">Выберите собеседников:</div>
                <div v-for="user in otherUsers" :key="user" class="flex items-center p-3 border-b hover:bg-gray-50">
                    <input type="checkbox" :value="user" v-model="selectedUsers" class="w-5 h-5 mr-3 accent-blue-600">
                    <span class="text-lg">{{ user }}</span>
                </div>
                <div v-if="otherUsers.length === 0" class="text-center text-gray-400 mt-10">
                    Сейчас нет других пользователей онлайн.
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50">
                <button @click="createChat" :disabled="selectedUsers.length === 0" 
                    class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold disabled:bg-gray-300 transition shadow">
                    {{ selectedUsers.length > 1 ? `Создать группу (${selectedUsers.length} уч.)` : 'Начать беседу' }}
                </button>
            </div>
        </div>
    </div>

    <!-- ЭКРАН 3: ОКНО ПЕРЕПИСКИ -->
    <div v-else class="flex flex-col h-full">
        <!-- Шапка чата -->
        <div class="bg-white p-3 border-b flex items-center shadow-sm z-10">
            <button @click="activeChat = null" class="mr-3 text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div class="flex flex-col">
                <span class="font-bold text-gray-800 leading-tight">{{ activeChat.name }}</span>
                <span class="text-xs text-gray-500">{{ activeChat.participants.length }} уч.</span>
            </div>
        </div>

        <!-- История сообщений -->
        <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50" id="messagesContainer">
            <div v-for="(msg, idx) in activeChat.messages" :key="idx" 
                 :class="['flex flex-col max-w-[80%]', msg.sender === myUsername ? 'self-end items-end' : 'self-start items-start']">
                <span v-if="activeChat.type === 'group' && msg.sender !== myUsername" class="text-xs text-gray-500 font-medium ml-1 mb-1">{{ msg.sender }}</span>
                <div :class="['p-3 rounded-2xl text-sm shadow-md', msg.sender === myUsername ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white border text-gray-800 rounded-bl-none']">
                    {{ msg.text }}
                </div>
                <span class="text-[10px] text-gray-400 mt-1 px-1">{{ msg.time }}</span>
            </div>
        </div>

        <!-- Ввод сообщения -->
        <div class="p-3 bg-white border-t flex items-center">
            <input v-model="messageText" @keyup.enter="sendMessage" placeholder="Сообщение..." class="flex-1 bg-gray-100 p-3 rounded-full focus:outline-none border border-transparent focus:border-blue-300 mr-2">
            <button @click="sendMessage" :disabled="!messageText.trim()" class="bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 disabled:bg-gray-400 transition">
                <svg class="w-5 h-5 rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
            </button>
        </div>
    </div>

</div>

<script>
    // ⭐️ ВАШ КОНФИГ FIREBASE ⭐️
    const firebaseConfig = {
        apiKey: "AIzaSyAcCc7TWexv0BsD3JGGirh2VeoMUu0iwnw",
        authDomain: "uchat-209a6.firebaseapp.com",
        projectId: "uchat-209a6",
        storageBucket: "uchat-209a6.firebasestorage.app",
        messagingSenderId: "1056856689884",
        appId: "1:1056856689884:web:d978aa3945d5666ca9f819",
        measurementId: "G-J80X22VP4E"
    };

    // Инициализация Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ⭐️ АДРЕС ВАШЕГО СЕРВЕРА НА RENDER ⭐️
    const SOCKET_SERVER_URL = 'https://chatserver-s05w.onrender.com';
    const socket = io(SOCKET_SERVER_URL);

    const { createApp } = Vue;

    createApp({
        data() {
            return {
                // Auth State
                registered: false,
                authMode: 'login', // 'login', 'register', 'reset'
                emailInput: '',
                passwordInput: '',

                // Chat State
                myUsername: '', // Будет хранить Firebase UID для Socket.io
                allUsers: [],
                chats: [],
                activeChat: null,
                showCreateModal: false,
                selectedUsers: [],
                messageText: ''
            }
        },
        computed: {
            otherUsers() {
                // Исключаем себя из списка доступных для чата
                return this.allUsers.filter(u => u !== this.myUsername);
            },
            myChats() {
                return this.chats.filter(c => c.participants.includes(this.myUsername));
            }
        },
        mounted() {
            // Firebase listener для автоматического входа
            auth.onAuthStateChanged((user) => {
                if (user) {
                    this.handleAuthSuccess(user);
                } else {
                    this.registered = false;
                    this.myUsername = '';
                }
            });

            // Socket.io listeners
            socket.on('registered', (data) => {
                this.myUsername = data.username;
                this.registered = true;
                this.allUsers = data.allUsers;
            });

            socket.on('update_users', (users) => {
                this.allUsers = users;
            });

            socket.on('new_chat', (chat) => {
                if (!this.chats.some(c => c.id === chat.id)) {
                    this.chats.push(chat);
                }
            });

            socket.on('update_chat', (updatedChat) => {
                const idx = this.chats.findIndex(c => c.id === updatedChat.id);
                if (idx !== -1) {
                    this.chats[idx] = updatedChat;
                    if (this.activeChat && this.activeChat.id === updatedChat.id) {
                        this.activeChat = updatedChat;
                        this.$nextTick(() => this.scrollToBottom());
                    }
                }
            });

            socket.on('connect', () => {
                 if (this.myUsername) {
                    // Перерегистрируемся на сервере Socket.io после переподключения
                    socket.emit('register', this.myUsername);
                 }
            });
        },
        methods: {
            // --- FIREBASE AUTH FUNCTIONS ---
            handleAuthSuccess(user) {
                 // Формируем отображаемое имя из Firebase UID (первые 8 символов)
                const uid_display = '@' + user.uid.substring(0, 8);
                
                // Передаем этот UID на Socket.io сервер
                socket.emit('register', uid_display);
                
                // Очистка форм
                this.emailInput = '';
                this.passwordInput = '';
            },

            async registerUser() {
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        this.emailInput,
                        this.passwordInput
                    );
                    alert('✅ Регистрация успешна! Вход выполнен автоматически.');
                    this.handleAuthSuccess(userCredential.user);

                } catch (error) {
                    alert('❌ Ошибка регистрации: ' + error.message);
                }
            },

            async loginUser() {
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(
                        this.emailInput,
                        this.passwordInput
                    );
                    alert('✅ Вход успешен!');
                    this.handleAuthSuccess(userCredential.user);

                } catch (error) {
                    alert('❌ Ошибка входа: ' + error.message);
                }
            },

            async logoutUser() {
                try {
                    await auth.signOut();
                    this.registered = false;
                    this.activeChat = null; // Закрыть активный чат
                    this.chats = []; // Очистить чаты
                    this.myUsername = '';
                    alert('Выход выполнен.');
                } catch (error) {
                    alert('Ошибка выхода: ' + error.message);
                }
            },

            async resetPassword() {
                if (!this.emailInput.trim()) {
                    alert('Пожалуйста, введите Email для сброса.');
                    return;
                }
                try {
                    await auth.sendPasswordResetEmail(this.emailInput);
                    alert('✅ Инструкции по сбросу пароля отправлены на ' + this.emailInput);
                    this.authMode = 'login';
                } catch (error) {
                    alert('❌ Ошибка сброса: ' + error.message);
                }
            },

            // --- CHAT FUNCTIONS ---
            createChat() {
                if (this.selectedUsers.length === 0) return;
                socket.emit('create_chat', this.selectedUsers);
                this.selectedUsers = [];
                this.showCreateModal = false;
            },
            openChat(chat) {
                this.activeChat = chat;
                this.$nextTick(() => this.scrollToBottom());
            },
            sendMessage() {
                if(!this.messageText.trim()) return;
                socket.emit('send_message', { chatId: this.activeChat.id, text: this.messageText });
                this.messageText = '';
            },
            scrollToBottom() {
                const container = document.getElementById('messagesContainer');
                if(container) container.scrollTop = container.scrollHeight;
            }
        }
    }).mount('#app');
</script>
</body>
</html>
